name: Deploy to Firebase

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '**/docs/**'
      - '**/README.md'
      - '**/SETUP.md'
      - '**/USER_GUIDE.md'
      - '**/scripts/**'
      - '.gitignore'
      - '.prettierrc'
      - '.prettierignore'

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ─── Detect which apps/packages changed ───────────────────────────
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      registration-hosting: ${{ steps.filter.outputs.registration-hosting }}
      registration-functions: ${{ steps.filter.outputs.registration-functions }}
      registration-storage: ${{ steps.filter.outputs.registration-storage }}
      checkin-hosting: ${{ steps.filter.outputs.checkin-hosting }}
      checkin-functions: ${{ steps.filter.outputs.checkin-functions }}
      firestore-rules: ${{ steps.filter.outputs.firestore-rules }}
      firestore-indexes: ${{ steps.filter.outputs.firestore-indexes }}
      hub-hosting: ${{ steps.filter.outputs.hub-hosting }}
      apply-hosting: ${{ steps.filter.outputs.apply-hosting }}
      apply-functions: ${{ steps.filter.outputs.apply-functions }}
      finance-hosting: ${{ steps.filter.outputs.finance-hosting }}
      finance-functions: ${{ steps.filter.outputs.finance-functions }}
      finance-rules: ${{ steps.filter.outputs.finance-rules }}
      finance-indexes: ${{ steps.filter.outputs.finance-indexes }}
      finance-storage: ${{ steps.filter.outputs.finance-storage }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            registration-hosting:
              - 'apps/registration/src/**'
              - 'apps/registration/public/**'
              - 'apps/registration/index.html'
              - 'apps/registration/package.json'
              - 'apps/registration/vite.config.*'
              - 'apps/registration/tsconfig*.json'
              - 'apps/registration/tailwind.config.*'
            registration-functions:
              - 'apps/registration/functions/**'
            registration-storage:
              - 'apps/registration/storage.rules'
            checkin-hosting:
              - 'apps/checkin/src/**'
              - 'apps/checkin/public/**'
              - 'apps/checkin/index.html'
              - 'apps/checkin/package.json'
              - 'apps/checkin/vite.config.*'
              - 'apps/checkin/tsconfig*.json'
              - 'apps/checkin/tailwind.config.*'
            checkin-functions:
              - 'apps/checkin/functions/**'
            firestore-rules:
              - 'firebase/checkin-ba4b8/firestore.rules'
            firestore-indexes:
              - 'firebase/checkin-ba4b8/firestore.indexes.json'
            finance-hosting:
              - 'apps/finance/src/**'
              - 'apps/finance/public/**'
              - 'apps/finance/index.html'
              - 'apps/finance/package.json'
              - 'apps/finance/vite.config.*'
              - 'apps/finance/tsconfig*.json'
              - 'apps/finance/tailwind.config.*'
            finance-functions:
              - 'apps/finance/functions/**'
            finance-rules:
              - 'apps/finance/firestore.rules'
            finance-indexes:
              - 'apps/finance/firestore.indexes.json'
            hub-hosting:
              - 'apps/hub/src/**'
              - 'apps/hub/public/**'
              - 'apps/hub/index.html'
              - 'apps/hub/package.json'
              - 'apps/hub/vite.config.*'
              - 'apps/hub/tsconfig*.json'
              - 'apps/hub/tailwind.config.*'
            apply-hosting:
              - 'apps/apply/src/**'
              - 'apps/apply/public/**'
              - 'apps/apply/index.html'
              - 'apps/apply/package.json'
              - 'apps/apply/vite.config.*'
              - 'apps/apply/tsconfig*.json'
              - 'apps/apply/tailwind.config.*'
            apply-functions:
              - 'apps/apply/functions/**'
            finance-storage:
              - 'apps/finance/storage.rules'
            shared:
              - 'packages/**'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
              - '.github/workflows/deploy.yml'

  # ─── Deploy Firestore Rules & Indexes (checkin-ba4b8 project) ────
  deploy-firestore:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.firestore-rules == 'true' ||
      needs.detect-changes.outputs.firestore-indexes == 'true'
    runs-on: ubuntu-latest
    environment: firestore

    steps:
      - uses: actions/checkout@v4

      - name: Setup Google credentials
        run: echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

      - name: Deploy Firestore Rules
        if: needs.detect-changes.outputs.firestore-rules == 'true'
        working-directory: firebase/checkin-ba4b8
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only firestore:rules --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Firestore Indexes
        if: needs.detect-changes.outputs.firestore-indexes == 'true'
        working-directory: firebase/checkin-ba4b8
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only firestore:indexes --project ${{ secrets.FIREBASE_PROJECT_ID }}

  # ─── Deploy Hub (hosting only, shares checkin-ba4b8 project) ─────
  deploy-hub:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.hub-hosting == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: hub

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm turbo build --filter=@conference/hub
        env:
          VITE_CHECKIN_URL: ${{ secrets.VITE_CHECKIN_URL }}
          VITE_REGISTRATION_URL: ${{ secrets.VITE_REGISTRATION_URL }}
          VITE_FINANCE_URL: ${{ secrets.VITE_FINANCE_URL }}
          VITE_APPLY_URL: ${{ secrets.VITE_APPLY_URL }}

      - name: Setup Google credentials
        run: echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

      - name: Deploy Hosting
        working-directory: apps/hub
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}

  # ─── Deploy Registration (hosting + functions, shares checkin-ba4b8 project) ─
  deploy-registration:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.registration-hosting == 'true' ||
      needs.detect-changes.outputs.registration-functions == 'true' ||
      needs.detect-changes.outputs.registration-storage == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: registration

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install functions dependencies
        if: needs.detect-changes.outputs.registration-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/registration/functions
        run: npm ci

      - name: Build
        if: needs.detect-changes.outputs.registration-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        run: pnpm turbo build --filter=@conference/registration
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: Build functions
        if: needs.detect-changes.outputs.registration-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/registration/functions
        run: npm run build

      - name: Setup Google credentials
        run: echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

      - name: Deploy Hosting
        if: needs.detect-changes.outputs.registration-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/registration
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Functions
        if: needs.detect-changes.outputs.registration-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/registration
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }} --force

      - name: Deploy Storage Rules
        if: needs.detect-changes.outputs.registration-storage == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/registration
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only storage --project ${{ secrets.FIREBASE_PROJECT_ID }}

  # ─── Deploy Checkin (hosting + functions) ──────────────────────
  deploy-checkin:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.checkin-hosting == 'true' ||
      needs.detect-changes.outputs.checkin-functions == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: checkin

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install functions dependencies
        if: needs.detect-changes.outputs.checkin-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/checkin/functions
        run: npm ci

      - name: Build
        if: needs.detect-changes.outputs.checkin-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        run: pnpm turbo build --filter=@conference/checkin
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_KEY_SECRET: ${{ secrets.VITE_KEY_SECRET }}

      - name: Build functions
        if: needs.detect-changes.outputs.checkin-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/checkin/functions
        run: npm run build

      - name: Setup Google credentials
        run: echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

      - name: Deploy Hosting
        if: needs.detect-changes.outputs.checkin-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/checkin
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Functions
        if: needs.detect-changes.outputs.checkin-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/checkin
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }} --force

  # ─── Deploy Apply (hosting + functions, shares checkin-ba4b8 project) ─
  deploy-apply:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.apply-hosting == 'true' ||
      needs.detect-changes.outputs.apply-functions == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: apply

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install functions dependencies
        if: needs.detect-changes.outputs.apply-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/apply/functions
        run: npm ci

      - name: Build
        if: needs.detect-changes.outputs.apply-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        run: pnpm turbo build --filter=@conference/apply
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: Build functions
        if: needs.detect-changes.outputs.apply-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/apply/functions
        run: npm run build

      - name: Setup Google credentials
        run: echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

      - name: Deploy Hosting
        if: needs.detect-changes.outputs.apply-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/apply
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Functions
        if: needs.detect-changes.outputs.apply-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/apply
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only functions:apply --project ${{ secrets.FIREBASE_PROJECT_ID }} --force

  # ─── Deploy Finance ───────────────────────────────────────────────
  deploy-finance:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.finance-hosting == 'true' ||
      needs.detect-changes.outputs.finance-functions == 'true' ||
      needs.detect-changes.outputs.finance-rules == 'true' ||
      needs.detect-changes.outputs.finance-indexes == 'true' ||
      needs.detect-changes.outputs.finance-storage == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    environment: finance

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install functions dependencies
        if: needs.detect-changes.outputs.finance-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance/functions
        run: npm ci

      - name: Build
        if: needs.detect-changes.outputs.finance-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        run: pnpm turbo build --filter=@conference/finance
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: Create functions .env
        if: needs.detect-changes.outputs.finance-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        run: |
          cat <<EOF > apps/finance/functions/.env
          APP_URL=${{ secrets.APP_URL }}
          STORAGE_BUCKET=${{ secrets.STORAGE_BUCKET }}
          EOF

      - name: Build functions
        if: needs.detect-changes.outputs.finance-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance/functions
        run: npm run build

      - name: Setup Google credentials
        run: echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

      - name: Deploy Hosting
        if: needs.detect-changes.outputs.finance-hosting == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only hosting --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Functions
        if: needs.detect-changes.outputs.finance-functions == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only functions --project ${{ secrets.FIREBASE_PROJECT_ID }} --force

      - name: Deploy Firestore Rules
        if: needs.detect-changes.outputs.finance-rules == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only firestore:rules --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Firestore Indexes
        if: needs.detect-changes.outputs.finance-indexes == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only firestore:indexes --project ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy Storage Rules
        if: needs.detect-changes.outputs.finance-storage == 'true' || needs.detect-changes.outputs.shared == 'true'
        working-directory: apps/finance
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-sa-key.json
        run: npx firebase-tools deploy --only storage --project ${{ secrets.FIREBASE_PROJECT_ID }}
